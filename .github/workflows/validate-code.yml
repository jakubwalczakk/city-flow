name: Code Validation (Reusable)

# ðŸŽ¯ Purpose:
# Reusable workflow for code validation used by master.yml and pull-request.yml
# Eliminates duplication and ensures consistent validation across all branches

on:
  workflow_call:
    inputs:
      artifact-prefix:
        description: 'Prefix for artifact names (e.g., "pr-123" or empty for master)'
        required: false
        type: string
        default: ''
      retention-days-coverage:
        description: 'Days to retain coverage artifacts'
        required: false
        type: number
        default: 30
      retention-days-e2e-report:
        description: 'Days to retain E2E reports'
        required: false
        type: number
        default: 30
      retention-days-e2e-results:
        description: 'Days to retain E2E results'
        required: false
        type: number
        default: 7
      upload-build-artifact:
        description: 'Whether to upload build artifact'
        required: false
        type: boolean
        default: false
      validate-e2e-secrets:
        description: 'Whether to validate E2E secrets before running tests'
        required: false
        type: boolean
        default: false
    secrets:
      SUPABASE_TEST_URL:
        required: true
      SUPABASE_TEST_KEY:
        required: true
      E2E_USER_ID:
        required: true
      E2E_USERNAME:
        required: true
      E2E_PASSWORD:
        required: true
    outputs:
      all-checks-passed:
        description: 'Whether all validation checks passed'
        value: ${{ jobs.summary.outputs.status }}

concurrency:
  group: validate-${{ github.ref }}-${{ inputs.artifact-prefix }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ðŸ” Code Quality Check
  # Runs in parallel with unit-tests and e2e-tests
  lint:
    name: ðŸ” Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run lint and format checks
        uses: ./.github/actions/lint-and-format

  # ðŸ§ª Unit Tests
  # Runs in parallel with lint and e2e-tests (no longer waits for lint)
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run unit tests with coverage
        uses: ./.github/actions/run-unit-tests
        with:
          artifact-name: ${{ inputs.artifact-prefix != '' && format('{0}-unit-coverage', inputs.artifact-prefix) || 'unit-test-coverage' }}
          retention-days: ${{ inputs.retention-days-coverage }}
          coverage-threshold: 0

  # ðŸŽ­ E2E Tests
  # Runs in parallel with lint and unit-tests (no longer waits for lint)
  # Uses cached Playwright browsers for faster execution
  e2e-tests:
    name: ðŸŽ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run E2E tests with Playwright
        uses: ./.github/actions/run-e2e-tests
        with:
          artifact-prefix: ${{ inputs.artifact-prefix }}
          retention-days-report: ${{ inputs.retention-days-e2e-report }}
          retention-days-results: ${{ inputs.retention-days-e2e-results }}
          validate-secrets: ${{ inputs.validate-e2e-secrets }}
          supabase-url: ${{ secrets.SUPABASE_TEST_URL }}
          supabase-key: ${{ secrets.SUPABASE_TEST_KEY }}
          e2e-user-id: ${{ secrets.E2E_USER_ID }}
          e2e-username: ${{ secrets.E2E_USERNAME }}
          e2e-password: ${{ secrets.E2E_PASSWORD }}

  # ðŸ”¨ Build Verification
  # Waits for all validation jobs to complete
  verify-build:
    name: ðŸ”¨ Verify Production Build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Build and verify
        uses: ./.github/actions/verify-build
        with:
          supabase-url: ${{ secrets.SUPABASE_TEST_URL || 'https://placeholder.supabase.co' }}
          supabase-key: ${{ secrets.SUPABASE_TEST_KEY || 'placeholder-key' }}
          artifact-name: ${{ inputs.artifact-prefix != '' && format('{0}-build', inputs.artifact-prefix) || 'production-build' }}
          retention-days: 7
          upload-artifact: ${{ inputs.upload-build-artifact }}

  # ðŸ“Š Validation Summary
  # Collects results and determines overall status
  summary:
    name: ðŸ“Š Validation Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests, verify-build]
    if: always()
    timeout-minutes: 5

    outputs:
      status: ${{ steps.status.outputs.result }}

    steps:
      - name: Determine overall status
        id: status
        run: |
          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.unit-tests.result }}" == "success" ] && \
             [ "${{ needs.e2e-tests.result }}" == "success" ] && \
             [ "${{ needs.verify-build.result }}" == "success" ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
          fi

      - name: Add summary to GitHub
        run: |
          echo "## ðŸ“Š Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint & Format | \`${{ needs.lint.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | \`${{ needs.unit-tests.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ­ E2E Tests | \`${{ needs.e2e-tests.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¨ Verify Build | \`${{ needs.verify-build.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.status.outputs.result }}" == "success" ]; then
            echo "### âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some checks failed" >> $GITHUB_STEP_SUMMARY
          fi
