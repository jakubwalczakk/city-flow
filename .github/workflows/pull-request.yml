name: Pull Request Validation

# ğŸ¯ Purpose:
# Validates pull requests before they can be merged to master.
# Runs the same checks as master.yml to ensure code quality and prevent broken deployments.

on:
  pull_request:
    branches:
      - master
      - main
    types: [opened, synchronize, reopened]

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

# Cancel previous runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Permissions for workflow operations
permissions:
  contents: read       # Read repository contents
  pull-requests: write # Write PR comments

jobs:
  # ğŸ” Code Quality Check
  # Ensures code follows style guidelines and best practices
  lint:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run lint and format checks
        uses: ./.github/actions/lint-and-format

  # ğŸ§ª Fast Unit Tests
  # Tests individual components and functions in isolation
  # These are fast, cheap, and catch most bugs early
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run unit tests
        uses: ./.github/actions/run-unit-tests
        with:
          artifact-name: pr-${{ github.event.pull_request.number }}-unit-coverage
          retention-days: 14
          coverage-threshold: 0

  # ğŸ­ End-to-End Tests
  # Tests complete user flows in a real browser
  # These catch integration issues and UX problems
  e2e-tests:
    name: ğŸ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          artifact-prefix: pr-${{ github.event.pull_request.number }}
          retention-days-report: 14
          retention-days-results: 7
          validate-secrets: true
          supabase-url: ${{ secrets.SUPABASE_TEST_URL }}
          supabase-key: ${{ secrets.SUPABASE_TEST_KEY }}
          e2e-user-id: ${{ secrets.E2E_USER_ID }}
          e2e-username: ${{ secrets.E2E_USERNAME }}
          e2e-password: ${{ secrets.E2E_PASSWORD }}

  # ğŸ”¨ Build Verification
  # Ensures the application builds successfully for production
  verify-build:
    name: ğŸ”¨ Verify Production Build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Verify production build
        uses: ./.github/actions/verify-build
        with:
          supabase-url: ${{ secrets.SUPABASE_TEST_URL || 'https://placeholder.supabase.co' }}
          supabase-key: ${{ secrets.SUPABASE_TEST_KEY || 'placeholder-key' }}
          upload-artifact: false

  # ğŸ“Š PR Status Summary with Comment
  # Provides a clear overview and posts automated comment
  status-comment:
    name: ğŸ“Š PR Status & Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests, verify-build]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine overall status
        id: status
        run: |
          LINT_STATUS="${{ needs.lint.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          BUILD_STATUS="${{ needs.verify-build.result }}"

          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "e2e_status=$E2E_STATUS" >> $GITHUB_OUTPUT
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT

          if [ "$LINT_STATUS" == "success" ] && \
             [ "$UNIT_STATUS" == "success" ] && \
             [ "$E2E_STATUS" == "success" ] && \
             [ "$BUILD_STATUS" == "success" ]; then
            echo "overall_status=success" >> $GITHUB_OUTPUT
            echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status_message=All checks passed! PR is ready to merge." >> $GITHUB_OUTPUT
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status_message=PR validation failed - fix issues before merging" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.status.outputs.lint_status }}';
            const unitStatus = '${{ steps.status.outputs.unit_status }}';
            const e2eStatus = '${{ steps.status.outputs.e2e_status }}';
            const buildStatus = '${{ steps.status.outputs.build_status }}';
            const overallStatus = '${{ steps.status.outputs.overall_status }}';
            const statusEmoji = '${{ steps.status.outputs.status_emoji }}';
            const statusMessage = '${{ steps.status.outputs.status_message }}';

            const getStatusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'cancelled') return 'âš ï¸';
              return 'â­ï¸';
            };

            const comment = `## ${statusEmoji} Pull Request Validation Results

            **Overall Status:** ${statusMessage}

            ### Job Results

            | Job | Status | Result |
            |-----|--------|--------|
            | ğŸ” Lint & Format | ${getStatusEmoji(lintStatus)} | \`${lintStatus}\` |
            | ğŸ§ª Unit Tests | ${getStatusEmoji(unitStatus)} | \`${unitStatus}\` |
            | ğŸ­ E2E Tests | ${getStatusEmoji(e2eStatus)} | \`${e2eStatus}\` |
            | ğŸ”¨ Verify Build | ${getStatusEmoji(buildStatus)} | \`${buildStatus}\` |

            ### Details

            - **Workflow Run:** [View Details #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Commit:** \`${{ github.event.pull_request.head.sha }}\`
            - **Branch:** \`${{ github.head_ref }}\`

            ${overallStatus === 'success' 
              ? 'ğŸ‰ **Great work!** All validation checks passed successfully. This PR is ready to merge!' 
              : 'âš ï¸  **Action Required:** Please review and fix the failing checks above before merging.'}

            ---

            <sub>ğŸ¤– Automated comment by [CityFlow CI/CD](${{ github.server_url }}/${{ github.repository }}/actions)</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Pull Request Validation Results')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
