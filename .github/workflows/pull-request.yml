name: CI/CD Pipeline

on:
  # Run on pull requests
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened]
  
  # Run on push to main/master
  push:
    branches:
      - main
      - master
  
  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run formatter check
        run: npm run format -- --check

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:unit -- --run --reporter=verbose --coverage

      - name: Display unit test coverage summary
        if: always()
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "ğŸ“Š Unit Test Coverage Summary:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cat coverage/coverage-summary.json | jq -r '.total | "Lines: \(.lines.pct)%\nStatements: \(.statements.pct)%\nFunctions: \(.functions.pct)%\nBranches: \(.branches.pct)%"'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

      - name: Upload unit test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: coverage/
          retention-days: 7
          if-no-files-found: error

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 20
    environment: integration

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx -y playwright install --with-deps chromium

      - name: Validate E2E secrets
        run: |
          MISSING_SECRETS=""
          
          if [ -z "${{ secrets.PUBLIC_SUPABASE_URL }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- PUBLIC_SUPABASE_URL\n"
          fi
          
          if [ -z "${{ secrets.PUBLIC_SUPABASE_KEY }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- PUBLIC_SUPABASE_KEY\n"
          fi
          
          if [ -z "${{ secrets.E2E_USER_ID }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- E2E_USER_ID\n"
          fi
          
          if [ -z "${{ secrets.E2E_USERNAME }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- E2E_USERNAME\n"
          fi
          
          if [ -z "${{ secrets.E2E_PASSWORD }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- E2E_PASSWORD\n"
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "âŒ Error: The following required secrets are not set:"
            echo ""
            echo -e "$MISSING_SECRETS"
            echo ""
            echo "E2E tests require these secrets to run."
            echo "See .github/E2E_TEST_USER_SETUP.md for setup instructions"
            exit 1
          fi
          
          echo "âœ… All required E2E secrets are configured"

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          COLLECT_COVERAGE: true
          # E2E Test User - REQUIRED
          E2E_USER_ID: ${{ secrets.E2E_USER_ID }}
          E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          # Supabase Configuration - REQUIRED
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_KEY: ${{ secrets.PUBLIC_SUPABASE_KEY }}

      - name: Generate E2E coverage report
        if: always()
        run: |
          if [ -d "coverage-e2e/.nyc_output" ] && [ "$(ls -A coverage-e2e/.nyc_output/*.json 2>/dev/null)" ]; then
            echo "ğŸ“Š Processing E2E coverage data..."
            npm run test:e2e:coverage
            echo "âœ… E2E coverage report generated"
          else
            echo "âš ï¸  No E2E coverage data found to process (.nyc_output directory not found or empty)"
            echo "Note: E2E coverage collection may not be configured in this test run"
          fi

      - name: Display E2E coverage summary
        if: always()
        run: |
          if [ -f "coverage-e2e/coverage-summary.json" ]; then
            echo "ğŸ“Š E2E Test Coverage Summary:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cat coverage-e2e/coverage-summary.json | jq -r '.total | "Lines: \(.lines.pct)%\nStatements: \(.statements.pct)%\nFunctions: \(.functions.pct)%\nBranches: \(.branches.pct)%"'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âš ï¸  No E2E coverage summary available (coverage not collected in this run)"
          fi

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
          if-no-files-found: error

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/
          retention-days: 7
          if-no-files-found: error

      - name: Upload E2E coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-coverage
          path: coverage-e2e/
          retention-days: 7
          if-no-files-found: warn

  status-comment:
    name: Post Status Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine overall status
        id: status
        run: |
          LINT_STATUS="${{ needs.lint.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          
          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "e2e_status=$E2E_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$LINT_STATUS" == "success" ] && [ "$UNIT_STATUS" == "success" ] && [ "$E2E_STATUS" == "success" ]; then
            echo "overall_status=success" >> $GITHUB_OUTPUT
            echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status_message=All checks passed!" >> $GITHUB_OUTPUT
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status_message=Some checks failed" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.status.outputs.lint_status }}';
            const unitStatus = '${{ steps.status.outputs.unit_status }}';
            const e2eStatus = '${{ steps.status.outputs.e2e_status }}';
            const overallStatus = '${{ steps.status.outputs.overall_status }}';
            const statusEmoji = '${{ steps.status.outputs.status_emoji }}';
            const statusMessage = '${{ steps.status.outputs.status_message }}';
            
            const getStatusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'cancelled') return 'âš ï¸';
              return 'â­ï¸';
            };
            
            const comment = `## ${statusEmoji} Pull Request Validation Results
            
            **Overall Status:** ${statusMessage}
            
            ### Job Results
            
            | Job | Status | Result |
            |-----|--------|--------|
            | ğŸ” Lint | ${getStatusEmoji(lintStatus)} | \`${lintStatus}\` |
            | ğŸ§ª Unit Tests | ${getStatusEmoji(unitStatus)} | \`${unitStatus}\` |
            | ğŸ­ E2E Tests | ${getStatusEmoji(e2eStatus)} | \`${e2eStatus}\` |
            
            ### Details
            
            - **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Commit:** \`${{ github.event.pull_request.head.sha }}\`
            - **Branch:** \`${{ github.head_ref }}\`
            
            ${overallStatus === 'success' 
              ? 'ğŸ‰ **Great work!** All validation checks passed successfully.' 
              : 'âš ï¸  **Action Required:** Please review and fix the failing checks above.'}
            
            ---
            
            <sub>ğŸ¤– Automated comment by [CityFlow CI/CD](${{ github.server_url }}/${{ github.repository }}/actions)</sub>
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Pull Request Validation Results')
            );
            
            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

