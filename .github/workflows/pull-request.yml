name: CI/CD Pipeline

on:
  # Run on pull requests
  pull_request:
    branches:
      - main
      - master
    types: [opened, synchronize, reopened]

  # Run on push to main/master
  push:
    branches:
      - main
      - master

  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run formatter check
        run: npm run format -- --check

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:unit -- --run --reporter=verbose --coverage

      - name: Display unit test coverage summary
        if: always()
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "ğŸ“Š Unit Test Coverage Summary:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cat coverage/coverage-summary.json | jq -r '.total | "Lines: \(.lines.pct)%\nStatements: \(.statements.pct)%\nFunctions: \(.functions.pct)%\nBranches: \(.branches.pct)%"'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

      - name: Upload unit test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: coverage/
          retention-days: 7
          if-no-files-found: error

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 20
    environment: integration

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx -y playwright install --with-deps chromium

      - name: Validate E2E secrets
        run: |
          MISSING_SECRETS=""

          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- SUPABASE_URL\n"
          fi

          if [ -z "${{ secrets.SUPABASE_KEY }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- SUPABASE_KEY\n"
          fi

          if [ -z "${{ secrets.E2E_USER_ID }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- E2E_USER_ID\n"
          fi

          if [ -z "${{ secrets.E2E_USERNAME }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- E2E_USERNAME\n"
          fi

          if [ -z "${{ secrets.E2E_PASSWORD }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}- E2E_PASSWORD\n"
          fi

          if [ -n "$MISSING_SECRETS" ]; then
            echo "âŒ Error: The following required secrets are not set:"
            echo ""
            echo -e "$MISSING_SECRETS"
            echo ""
            echo "E2E tests require these secrets to run."
            echo "See .github/E2E_TEST_USER_SETUP.md for setup instructions"
            exit 1
          fi

          echo "âœ… All required E2E secrets are configured"

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          COLLECT_COVERAGE: true
          # E2E Test User - REQUIRED
          E2E_USER_ID: ${{ secrets.E2E_USER_ID }}
          E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          # Supabase Configuration - REQUIRED
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: Process E2E coverage
        if: always()
        run: |
          echo "ğŸ” Checking for E2E coverage data..."

          # Create coverage directory if it doesn't exist
          mkdir -p coverage-e2e/.nyc_output

          # Count coverage files
          COVERAGE_FILE_COUNT=$(ls -1 coverage-e2e/.nyc_output/*.json 2>/dev/null | wc -l)

          if [ "$COVERAGE_FILE_COUNT" -gt 0 ]; then
            echo "ğŸ“Š Found $COVERAGE_FILE_COUNT coverage file(s)"
            ls -lh coverage-e2e/.nyc_output/
            echo ""
            echo "Generating coverage report..."
            npm run test:e2e:coverage
            echo ""
            
            # Display summary if generated
            if [ -f "coverage-e2e/coverage-summary.json" ]; then
              echo "âœ… E2E Coverage Report:"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              cat coverage-e2e/coverage-summary.json | jq -r '.total | "Lines: \(.lines.pct)%\nStatements: \(.statements.pct)%\nFunctions: \(.functions.pct)%\nBranches: \(.branches.pct)%"'
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            else
              echo "âš ï¸  NYC report command completed but summary not generated"
              echo "Check if .nycrc.json includes 'json-summary' reporter"
            fi
          else
            echo "âš ï¸  No E2E coverage data collected"
            echo ""
            echo "Note: Coverage collection is limited because:"
            echo "  â€¢ Tests mock API endpoints (backend code doesn't execute)"
            echo "  â€¢ Only client-side code execution is captured"
            echo "  â€¢ This is expected for UI-focused E2E tests"
          fi

      - name: Prepare E2E artifacts
        id: prepare-artifacts
        if: always()
        run: |
          echo "ğŸ“¦ Checking E2E test artifacts..."
          echo ""

          # Check Playwright HTML report (always generated)
          if [ -d "playwright-report" ] && [ "$(ls -A playwright-report)" ]; then
            echo "âœ… Playwright HTML report found"
            HAS_REPORT=true
          else
            echo "âš ï¸  No Playwright report found"
            HAS_REPORT=false
          fi

          # Check test results (traces/screenshots - only on failures)
          if [ -d "test-results" ] && [ "$(ls -A test-results)" ]; then
            echo "ğŸ“¸ Test results found (traces/screenshots from failed tests)"
            HAS_RESULTS=true
          else
            echo "âœ… No test failure artifacts (all tests passed)"
            HAS_RESULTS=false
          fi

          # Determine what to upload
          if [ "$HAS_REPORT" = true ] || [ "$HAS_RESULTS" = true ]; then
            echo "has_artifacts=true" >> $GITHUB_OUTPUT
            echo ""
            echo "Will upload available artifacts..."
          else
            echo "has_artifacts=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸  No E2E artifacts to upload"
          fi

      - name: Upload E2E test artifacts
        if: always() && steps.prepare-artifacts.outputs.has_artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts
          path: |
            playwright-report/
            test-results/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload E2E coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-coverage
          path: coverage-e2e/
          retention-days: 7
          if-no-files-found: warn

  status-comment:
    name: Post Status Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine overall status
        id: status
        run: |
          LINT_STATUS="${{ needs.lint.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"

          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "e2e_status=$E2E_STATUS" >> $GITHUB_OUTPUT

          if [ "$LINT_STATUS" == "success" ] && [ "$UNIT_STATUS" == "success" ] && [ "$E2E_STATUS" == "success" ]; then
            echo "overall_status=success" >> $GITHUB_OUTPUT
            echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status_message=All checks passed!" >> $GITHUB_OUTPUT
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status_message=Some checks failed" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.status.outputs.lint_status }}';
            const unitStatus = '${{ steps.status.outputs.unit_status }}';
            const e2eStatus = '${{ steps.status.outputs.e2e_status }}';
            const overallStatus = '${{ steps.status.outputs.overall_status }}';
            const statusEmoji = '${{ steps.status.outputs.status_emoji }}';
            const statusMessage = '${{ steps.status.outputs.status_message }}';

            const getStatusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'cancelled') return 'âš ï¸';
              return 'â­ï¸';
            };

            const comment = `## ${statusEmoji} Pull Request Validation Results

            **Overall Status:** ${statusMessage}

            ### Job Results

            | Job | Status | Result |
            |-----|--------|--------|
            | ğŸ” Lint | ${getStatusEmoji(lintStatus)} | \`${lintStatus}\` |
            | ğŸ§ª Unit Tests | ${getStatusEmoji(unitStatus)} | \`${unitStatus}\` |
            | ğŸ­ E2E Tests | ${getStatusEmoji(e2eStatus)} | \`${e2eStatus}\` |

            ### Details

            - **Workflow Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Commit:** \`${{ github.event.pull_request.head.sha }}\`
            - **Branch:** \`${{ github.head_ref }}\`

            ${overallStatus === 'success' 
              ? 'ğŸ‰ **Great work!** All validation checks passed successfully.' 
              : 'âš ï¸  **Action Required:** Please review and fix the failing checks above.'}

            ---

            <sub>ğŸ¤– Automated comment by [CityFlow CI/CD](${{ github.server_url }}/${{ github.repository }}/actions)</sub>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Pull Request Validation Results')
            );

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
