name: Master CI/CD Pipeline

# ğŸ¯ Purpose:
# This workflow validates code quality, runs tests, and verifies the build
# before Vercel automatically deploys to production.
#
# ğŸš€ Deployment:
# Each job notifies Vercel about its status using vercel/repository-dispatch.
# Vercel waits for all checks to pass before deploying to production.
# No manual configuration in Vercel Dashboard needed!

on:
  # Run on push to master
  push:
    branches:
      - master

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

# Prevent multiple runs for the same branch
# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ============================================================================
# JOBS: All jobs run in parallel when possible to optimize pipeline speed
# ============================================================================

jobs:
  # ğŸ” Code Quality Check
  # Ensures code follows style guidelines and best practices
  lint:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check code formatting
        run: npm run format -- --check

      - name: Notify Vercel
        if: always()
        uses: vercel/repository-dispatch/actions/status@v1
        with:
          name: 'Vercel - city-flow: lint'

  # ğŸ§ª Fast Unit Tests
  # Tests individual components and functions in isolation
  # These are fast, cheap, and catch most bugs early
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:unit -- --run --reporter=verbose --coverage

      - name: Display coverage summary
        if: always()
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "ğŸ“Š Unit Test Coverage Summary:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cat coverage/coverage-summary.json | jq -r '.total | "Lines: \(.lines.pct)%\nStatements: \(.statements.pct)%\nFunctions: \(.functions.pct)%\nBranches: \(.branches.pct)%"'
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: coverage/
          retention-days: 30
          if-no-files-found: error

      - name: Check coverage thresholds
        if: always()
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            LINES_PCT=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            THRESHOLD=0
            if (( $(echo "$LINES_PCT < $THRESHOLD" | bc -l) )); then
              echo "âŒ Coverage below threshold: ${LINES_PCT}% < ${THRESHOLD}%"
              exit 1
            fi
            echo "âœ… Coverage meets threshold: ${LINES_PCT}% >= ${THRESHOLD}%"
          fi

      - name: Notify Vercel
        if: always()
        uses: vercel/repository-dispatch/actions/status@v1
        with:
          name: 'Vercel - city-flow: unit-tests'

  # ğŸ­ End-to-End Tests
  # Tests complete user flows in a real browser
  # These catch integration issues and UX problems
  e2e-tests:
    name: ğŸ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          # Use ONLY test database (never production!) to avoid data corruption
          # SUPABASE_TEST_URL and SUPABASE_TEST_KEY should point to a separate test project
          SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_TEST_KEY }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Notify Vercel
        if: always()
        uses: vercel/repository-dispatch/actions/status@v1
        with:
          name: 'Vercel - city-flow: e2e-tests'

  # ğŸ”¨ Build Verification
  # Ensures the application builds successfully for production
  verify-build:
    name: ğŸ”¨ Verify Production Build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build
        env:
          # Build uses test credentials (safe - build only compiles, doesn't execute queries)
          # Fallback to placeholder if test credentials not set
          SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL || 'https://placeholder.supabase.co' }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_TEST_KEY || 'placeholder-key' }}

      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build directory not found!"
            exit 1
          fi
          echo "âœ… Build successful - dist directory created"
          echo "ğŸ“¦ Build size:"
          du -sh dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 7
          if-no-files-found: error

      - name: Notify Vercel
        if: always()
        uses: vercel/repository-dispatch/actions/status@v1
        with:
          name: 'Vercel - city-flow: verify-build'

  # ğŸ“Š Pipeline Status Summary
  # Provides a clear overview of all checks
  status-summary:
    name: ğŸ“Š Pipeline Status
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests, verify-build]
    if: always()

    steps:
      - name: Determine overall status
        id: status
        run: |
          LINT_STATUS="${{ needs.lint.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          BUILD_STATUS="${{ needs.verify-build.result }}"

          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "e2e_status=$E2E_STATUS" >> $GITHUB_OUTPUT
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT

          if [ "$LINT_STATUS" == "success" ] && \
             [ "$UNIT_STATUS" == "success" ] && \
             [ "$E2E_STATUS" == "success" ] && \
             [ "$BUILD_STATUS" == "success" ]; then
            echo "overall_status=success" >> $GITHUB_OUTPUT
            echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status_message=All checks passed! Ready for Vercel deployment." >> $GITHUB_OUTPUT
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status_message=Pipeline failed - deployment blocked" >> $GITHUB_OUTPUT
          fi

      - name: Display pipeline summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "${{ steps.status.outputs.status_emoji }} CityFlow Master Pipeline Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Job Results:"
          echo "  ğŸ” Lint & Format:    ${{ needs.lint.result }}"
          echo "  ğŸ§ª Unit Tests:       ${{ needs.unit-tests.result }}"
          echo "  ğŸ­ E2E Tests:        ${{ needs.e2e-tests.result }}"
          echo "  ğŸ”¨ Verify Build:     ${{ needs.verify-build.result }}"
          echo ""
          echo "ğŸ“Š Overall Status: ${{ steps.status.outputs.status_message }}"
          echo ""
          echo "ğŸš€ Deployment:"
          if [ "${{ steps.status.outputs.overall_status }}" == "success" ]; then
            echo "  âœ… All checks passed - Vercel will deploy to production!"
            echo "  ğŸ“Š Monitor deployment: https://vercel.com/dashboard"
          else
            echo "  âŒ Deployment blocked - one or more checks failed."
            echo "  ğŸ”§ Fix the issues above and push again."
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Comment on commit (optional)
        if: github.event_name == 'push'
        run: |
          echo "ğŸ’¡ Tip: To add automatic PR comments, enable GitHub Actions permissions"
          echo "Settings â†’ Actions â†’ General â†’ Workflow permissions â†’ Read and write"
