name: Master CI/CD Pipeline

# ğŸ¯ Purpose:
# This workflow validates code quality, runs tests, and verifies the build
# before Vercel automatically deploys to production.
#
# ğŸš€ Deployment:
# Vercel uses "Ignored Build Step" (scripts/check-ci-status.js) to check
# if all GitHub Actions checks passed before starting the build.
# This ensures broken code never reaches production.

on:
  # Run on push to master
  push:
    branches:
      - master

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

# Prevent multiple runs for the same branch
# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Permissions for workflow operations
permissions:
  contents: read       # Read repository contents

# ============================================================================
# JOBS: All jobs run in parallel when possible to optimize pipeline speed
# ============================================================================

jobs:
  # ğŸ” Code Quality Check
  # Ensures code follows style guidelines and best practices
  lint:
    name: ğŸ” Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run lint and format checks
        uses: ./.github/actions/lint-and-format

  # ğŸ§ª Fast Unit Tests
  # Tests individual components and functions in isolation
  # These are fast, cheap, and catch most bugs early
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run unit tests
        uses: ./.github/actions/run-unit-tests
        with:
          artifact-name: unit-test-coverage
          retention-days: 30
          coverage-threshold: 0

  # ğŸ­ End-to-End Tests
  # Tests complete user flows in a real browser
  # These catch integration issues and UX problems
  e2e-tests:
    name: ğŸ­ E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Run E2E tests
        uses: ./.github/actions/run-e2e-tests
        with:
          artifact-prefix: ''
          retention-days-report: 30
          retention-days-results: 7
          validate-secrets: false
          supabase-url: ${{ secrets.SUPABASE_TEST_URL }}
          supabase-key: ${{ secrets.SUPABASE_TEST_KEY }}
          e2e-user-id: ${{ secrets.E2E_USER_ID }}
          e2e-username: ${{ secrets.E2E_USERNAME }}
          e2e-password: ${{ secrets.E2E_PASSWORD }}

  # ğŸ”¨ Build Verification
  # Ensures the application builds successfully for production
  verify-build:
    name: ğŸ”¨ Verify Production Build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and dependencies
        uses: ./.github/actions/setup-node-dependencies

      - name: Verify production build
        uses: ./.github/actions/verify-build
        with:
          supabase-url: ${{ secrets.SUPABASE_TEST_URL || 'https://placeholder.supabase.co' }}
          supabase-key: ${{ secrets.SUPABASE_TEST_KEY || 'placeholder-key' }}
          artifact-name: production-build
          retention-days: 7
          upload-artifact: true

  # ğŸ“Š Pipeline Status Summary
  # Provides a clear overview of all checks
  status-summary:
    name: ğŸ“Š Pipeline Status
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests, verify-build]
    if: always()

    steps:
      - name: Determine overall status
        id: status
        run: |
          LINT_STATUS="${{ needs.lint.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          BUILD_STATUS="${{ needs.verify-build.result }}"

          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "e2e_status=$E2E_STATUS" >> $GITHUB_OUTPUT
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT

          if [ "$LINT_STATUS" == "success" ] && \
             [ "$UNIT_STATUS" == "success" ] && \
             [ "$E2E_STATUS" == "success" ] && \
             [ "$BUILD_STATUS" == "success" ]; then
            echo "overall_status=success" >> $GITHUB_OUTPUT
            echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status_message=All checks passed! Ready for Vercel deployment." >> $GITHUB_OUTPUT
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status_message=Pipeline failed - deployment blocked" >> $GITHUB_OUTPUT
          fi

      - name: Display pipeline summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "${{ steps.status.outputs.status_emoji }} CityFlow Master Pipeline Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Job Results:"
          echo "  ğŸ” Lint & Format:    ${{ needs.lint.result }}"
          echo "  ğŸ§ª Unit Tests:       ${{ needs.unit-tests.result }}"
          echo "  ğŸ­ E2E Tests:        ${{ needs.e2e-tests.result }}"
          echo "  ğŸ”¨ Verify Build:     ${{ needs.verify-build.result }}"
          echo ""
          echo "ğŸ“Š Overall Status: ${{ steps.status.outputs.status_message }}"
          echo ""
          echo "ğŸš€ Deployment:"
          if [ "${{ steps.status.outputs.overall_status }}" == "success" ]; then
            echo "  âœ… All checks passed - Vercel will deploy to production!"
            echo "  ğŸ“Š Monitor deployment: https://vercel.com/dashboard"
          else
            echo "  âŒ Deployment blocked - one or more checks failed."
            echo "  ğŸ”§ Fix the issues above and push again."
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Comment on commit (optional)
        if: github.event_name == 'push'
        run: |
          echo "ğŸ’¡ Tip: To add automatic PR comments, enable GitHub Actions permissions"
          echo "Settings â†’ Actions â†’ General â†’ Workflow permissions â†’ Read and write"
