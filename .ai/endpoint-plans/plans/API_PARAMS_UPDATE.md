# API Query Parameters - Plans Endpoint

## Overview

The `/api/plans` endpoint uses `statuses` parameter (plural form) for filtering by plan status, regardless of whether you're filtering by one or multiple values.

## Query Parameters

### Status Filtering

#### `statuses` - Status Filter (Single or Multiple)

Use `statuses` for filtering by plan status. Supports both single and multiple values.

**Examples:**

```bash
# Multiple statuses (comma-separated)
GET /api/plans?statuses=draft,generated

# Single status
GET /api/plans?statuses=draft

# No filter (returns all statuses)
GET /api/plans
```

**Result:**

- `statuses=draft,generated` → Returns plans with status "draft" OR "generated"
- `statuses=draft` → Returns only plans with status "draft"
- No parameter → Returns all plans (no filter applied)

---

## Complete API Examples

### 1. Get all active plans (draft + generated)

```bash
GET /api/plans?statuses=draft,generated&limit=12&offset=0&sort_by=created_at&order=desc
```

### 2. Get archived plans

```bash
GET /api/plans?statuses=archived&limit=12&offset=0&sort_by=created_at&order=desc
```

### 3. Get only draft plans

```bash
GET /api/plans?statuses=draft&limit=20&offset=0
```

### 4. Get all plans (no status filter)

```bash
GET /api/plans?limit=20&offset=0
```

---

## Valid Status Values

- `draft` - Plan is in draft state
- `generated` - Plan has been generated by AI
- `archived` - Plan has been archived

---

## Implementation Details

### Backend Changes

**1. Schema Validation (`plan.schema.ts`):**

```typescript
export const listPlansQuerySchema = z.object({
  statuses: z.preprocess(
    (val) => {
      if (!val) return undefined;
      if (typeof val === "string" && val.includes(",")) {
        return val.split(",").map((s) => s.trim());
      }
      if (typeof val === "string") {
        return [val];
      }
      return val;
    },
    z.array(z.enum(["draft", "generated", "archived"])).optional()
  ),
  // ... other fields
});
```

**2. API Endpoint (`pages/api/plans.ts`):**

```typescript
const queryParams = {
  statuses: url.searchParams.get("statuses"),
  sort_by: url.searchParams.get("sort_by"),
  order: url.searchParams.get("order"),
  limit: url.searchParams.get("limit"),
  offset: url.searchParams.get("offset"),
};

// Map to service layer
const result = await getPlans(supabase, user.id, {
  ...validation.data,
  status: validation.data.statuses,
});
```

**3. Frontend Hook (`usePlans.ts`):**

```typescript
// Always use 'statuses' parameter (supports single or multiple values)
if (params.status) {
  const statusArray = Array.isArray(params.status) ? params.status : [params.status];
  searchParams.set("statuses", statusArray.join(","));
}
```

---

## API Design Decision

✅ **Always use `statuses` (plural)** - even for single values

- Consistent API naming convention
- No confusion about which parameter to use
- Simpler implementation and maintenance

---

## Testing

### Test Cases Verified

1. ✅ `statuses=draft,generated` → Returns multiple statuses
2. ✅ `statuses=draft` → Single value works
3. ✅ No statuses parameter → No filter applied (returns all)

---

## Usage Examples

```javascript
// Multiple statuses
fetch("/api/plans?statuses=draft,generated&limit=12&offset=0");

// Single status (still use 'statuses')
fetch("/api/plans?statuses=draft&limit=12&offset=0");

// No filter
fetch("/api/plans?limit=12&offset=0");
```
